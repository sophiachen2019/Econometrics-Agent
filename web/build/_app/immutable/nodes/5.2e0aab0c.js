import{s as et,a as ve,e as Le,M as tt,d as V,c as Ae,i as He,w as X,o as ot,p as z,f as fe,g as pe,h as de,j as Z,r as x,u as st,W as $,t as H}from"../chunks/scheduler.161605a7.js";import{S as nt,i as at,a as te,t as le,c as lt,f as ee,b as Me,d as Te,m as Ce,e as Ee,g as rt}from"../chunks/index.acd0f037.js";import{g as it}from"../chunks/globals.7f7f1b26.js";import{a as B}from"../chunks/Toaster.svelte_svelte_type_style_lang.51e71bae.js";import{g as Ne}from"../chunks/navigation.7dcef832.js";import{p as ct}from"../chunks/stores.3e8eb66e.js";import{e as ge,g as Pe,a as Je,L as ut,O as ft,f as Ge,s as We,m as pt,j as dt,W as gt,c as mt}from"../chunks/index.7deef04d.js";import{v as je,s as qe,c as Ve,d as ht}from"../chunks/index.496e36ff.js";import{e as _t,f as wt,h as Fe}from"../chunks/index.781620a4.js";import{c as yt,b as me,t as he,y as bt,x as ze,z as St,A as kt,r as It}from"../chunks/index.9f4636fe.js";import{d as Mt}from"../chunks/index.1d44562a.js";import{N as Tt,M as Ct,a as Et,b as Nt}from"../chunks/Navbar.6cdab601.js";const{document:De}=it;function Ye(o){var ye;let S,t,s,p,u,f,_,oe,Y,se,T,w,C,U,k,P,I,M,L,K,J,v,r;t=new Tt({props:{title:o[9],shareEnabled:o[12].length>0,initNewChat:o[26],tags:o[8],addTag:o[22],deleteTag:o[23]}});function l(n){o[27](n)}let _e={};o[0]!==void 0&&(_e.selectedModels=o[0]),_=new Ct({props:_e}),z.push(()=>ee(_,"selectedModels",l));function W(n){o[28](n)}function Oe(n){o[29](n)}function re(n){o[30](n)}let Q={chatId:o[14],selectedModels:o[0],selectedModelfiles:o[7],processing:vt,bottomPadding:o[11].length>0,sendPrompt:o[18],continueGeneration:o[20],regenerateResponse:o[21]};o[1]!==void 0&&(Q.history=o[1]),o[12]!==void 0&&(Q.messages=o[12]),o[3]!==void 0&&(Q.autoScroll=o[3]),w=new Et({props:Q}),z.push(()=>ee(w,"history",W)),z.push(()=>ee(w,"messages",Oe)),z.push(()=>ee(w,"autoScroll",re));function we(n){o[33](n)}function Be(n){o[34](n)}function Ue(n){o[35](n)}let ne={suggestionPrompts:((ye=o[6])==null?void 0:ye.suggestionPrompts)??o[16].default_prompt_suggestions,messages:o[12],submitPrompt:o[17],stopResponse:o[19]};return o[11]!==void 0&&(ne.files=o[11]),o[10]!==void 0&&(ne.prompt=o[10]),o[3]!==void 0&&(ne.autoScroll=o[3]),I=new Nt({props:ne}),z.push(()=>ee(I,"files",we)),z.push(()=>ee(I,"prompt",Be)),z.push(()=>ee(I,"autoScroll",Ue)),{c(){S=fe("div"),Me(t.$$.fragment),s=ve(),p=fe("div"),u=fe("div"),f=fe("div"),Me(_.$$.fragment),se=ve(),T=fe("div"),Me(w.$$.fragment),P=ve(),Me(I.$$.fragment),this.h()},l(n){S=pe(n,"DIV",{class:!0});var g=de(S);Te(t.$$.fragment,g),s=Ae(g),p=pe(g,"DIV",{class:!0});var A=de(p);u=pe(A,"DIV",{class:!0,id:!0});var j=de(u);f=pe(j,"DIV",{class:!0});var E=de(f);Te(_.$$.fragment,E),E.forEach(V),se=Ae(j),T=pe(j,"DIV",{class:!0});var R=de(T);Te(w.$$.fragment,R),R.forEach(V),j.forEach(V),P=Ae(A),Te(I.$$.fragment,A),A.forEach(V),g.forEach(V),this.h()},h(){var n;Z(f,"class",Y=(((n=o[13])==null?void 0:n.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"),Z(T,"class","h-full w-full flex flex-col py-8"),Z(u,"class","pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0"),Z(u,"id","messages-container"),Z(p,"class","flex flex-col flex-auto"),Z(S,"class","min-h-screen max-h-screen w-full flex flex-col")},m(n,g){He(n,S,g),Ce(t,S,null),x(S,s),x(S,p),x(p,u),x(u,f),Ce(_,f,null),x(u,se),x(u,T),Ce(w,T,null),o[31](u),x(p,P),Ce(I,p,null),J=!0,v||(r=st(u,"scroll",o[32]),v=!0)},p(n,g){var be,Se;const A={};g[0]&512&&(A.title=n[9]),g[0]&4096&&(A.shareEnabled=n[12].length>0),g[0]&32&&(A.initNewChat=n[26]),g[0]&256&&(A.tags=n[8]),t.$set(A);const j={};!oe&&g[0]&1&&(oe=!0,j.selectedModels=n[0],$(()=>oe=!1)),_.$set(j),(!J||g[0]&8192&&Y!==(Y=(((be=n[13])==null?void 0:be.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"))&&Z(f,"class",Y);const E={};g[0]&16384&&(E.chatId=n[14]),g[0]&1&&(E.selectedModels=n[0]),g[0]&128&&(E.selectedModelfiles=n[7]),g[0]&2048&&(E.bottomPadding=n[11].length>0),!C&&g[0]&2&&(C=!0,E.history=n[1],$(()=>C=!1)),!U&&g[0]&4096&&(U=!0,E.messages=n[12],$(()=>U=!1)),!k&&g[0]&8&&(k=!0,E.autoScroll=n[3],$(()=>k=!1)),w.$set(E);const R={};g[0]&65600&&(R.suggestionPrompts=((Se=n[6])==null?void 0:Se.suggestionPrompts)??n[16].default_prompt_suggestions),g[0]&4096&&(R.messages=n[12]),!M&&g[0]&2048&&(M=!0,R.files=n[11],$(()=>M=!1)),!L&&g[0]&1024&&(L=!0,R.prompt=n[10],$(()=>L=!1)),!K&&g[0]&8&&(K=!0,R.autoScroll=n[3],$(()=>K=!1)),I.$set(R)},i(n){J||(te(t.$$.fragment,n),te(_.$$.fragment,n),te(w.$$.fragment,n),te(I.$$.fragment,n),J=!0)},o(n){le(t.$$.fragment,n),le(_.$$.fragment,n),le(w.$$.fragment,n),le(I.$$.fragment,n),J=!1},d(n){n&&V(S),Ee(t),Ee(_),Ee(w),o[31](null),Ee(I),v=!1,r()}}}function Pt(o){let S,t,s,p;De.title=S=`
		`+(o[9]?`${o[9].length>30?`${o[9].slice(0,30)}...`:o[9]} | ${o[15]}`:`${o[15]}`)+`
	`;let u=o[2]&&Ye(o);return{c(){t=ve(),u&&u.c(),s=Le()},l(f){tt("svelte-1123lr8",De.head).forEach(V),t=Ae(f),u&&u.l(f),s=Le()},m(f,_){He(f,t,_),u&&u.m(f,_),He(f,s,_),p=!0},p(f,_){(!p||_[0]&33280)&&S!==(S=`
		`+(f[9]?`${f[9].length>30?`${f[9].slice(0,30)}...`:f[9]} | ${f[15]}`:`${f[15]}`)+`
	`)&&(De.title=S),f[2]?u?(u.p(f,_),_[0]&4&&te(u,1)):(u=Ye(f),u.c(),te(u,1),u.m(s.parentNode,s)):u&&(rt(),le(u,1,1,()=>{u=null}),lt())},i(f){p||(te(u),p=!0)},o(f){le(u),p=!1},d(f){f&&(V(t),V(s)),u&&u.d(f)}}}let vt="";function At(o,S,t){let s,p,u,f,_,oe,Y;X(o,We,e=>t(13,s=e)),X(o,Pe,e=>t(14,p=e)),X(o,pt,e=>t(38,u=e)),X(o,ct,e=>t(24,f=e)),X(o,dt,e=>t(25,_=e)),X(o,gt,e=>t(15,oe=e)),X(o,mt,e=>t(16,Y=e));let se=!1,T=!1,w=!0,C,U=null,k=[""],P=null,I={},M=null,L=[],K="",J="",v=[],r=[],l={messages:{},currentId:null};const _e=async()=>{if(await Pe.set(f.params.id),M=await It(localStorage.token,p).catch(async e=>(await Ne("/"),null)),M){t(8,L=await g());const e=M.chat;if(e){console.log(e),t(0,k=((e==null?void 0:e.models)??void 0)!==void 0?e.models:[e.models??""]),t(1,l=((e==null?void 0:e.history)??void 0)!==void 0?e.history:ht(e.messages)),t(9,K=e.title);let c=JSON.parse(localStorage.getItem("settings")??"{}");return await We.set({...c,system:e.system??c.system,options:e.options??c.options}),t(3,w=!0),await H(),r.length>0&&t(1,l.messages[r.at(-1).id].done=!0,l),await H(),!0}else return null}},W=()=>{t(4,C.scrollTop=C.scrollHeight,C)},Oe=async(e,c=null)=>{if(console.log("submitPrompt",p),k.includes(""))B.error("Model not selected");else if(r.length!=0&&r.at(-1).done!=!0)console.log("wait");else if(v.length>0&&v.filter(h=>h.upload_status===!1).length>0)B.error("Oops! Hold tight! Your files are still in the processing oven. We're cooking them up to perfection. Please be patient and we'll let you know once they're ready.");else{document.getElementById("chat-textarea").style.height="";let h=je(),y={id:h,parentId:r.length!==0?r.at(-1).id:null,childrenIds:[],role:"user",user:c??void 0,content:e,files:v.length>0?v:void 0,timestamp:Math.floor(Date.now()/1e3)};t(1,l.messages[h]=y,l),t(1,l.currentId=h,l),r.length!==0&&l.messages[r.at(-1).id].childrenIds.push(h),await H(),r.length==1&&(s.saveChatHistory??!0?(M=await yt(localStorage.token,{id:p,title:"New Chat",models:k,system:s.system??void 0,options:{...s.options??{}},messages:r,history:l,timestamp:Date.now()}),await ge.set(await me(localStorage.token)),await Pe.set(M.id)):await Pe.set("local"),await H()),t(10,J=""),t(11,v=[]),await re(e,h)}},re=async(e,c)=>{const h=JSON.parse(JSON.stringify(p));await Promise.all(k.map(async y=>{const a=u.filter(b=>b.id===y).at(0);if(a){let b=je(),O={parentId:c,id:b,childrenIds:[],role:"assistant",content:"",model:a.id,timestamp:Math.floor(Date.now()/1e3)};t(1,l.messages[b]=O,l),t(1,l.currentId=b,l),c!==null&&t(1,l.messages[c].childrenIds=[...l.messages[c].childrenIds,b],l),a!=null&&a.external?await we(a,e,b,h):a&&await Q(a,e,b,h)}else B.error(`Model ${y} not found`)})),await ge.set(await me(localStorage.token))},Q=async(e,c,h,y)=>{var ue;e=e.id;const a=l.messages[h];await H(),W();const b=[s.system?{role:"system",content:s.system}:void 0,...r].filter(d=>d).map((d,N,ae)=>{var m;const D={role:d.role,content:ae.length-2!==N?d.content:(d==null?void 0:d.raContent)??d.content},i=(m=d.files)==null?void 0:m.filter(G=>G.type==="image").map(G=>G.url.slice(G.url.indexOf(",")+1));return i&&i.length>0&&(D.images=i),D});let O=-1;b.forEach((d,N)=>{d.images&&(O=N)}),b.forEach((d,N)=>{N!==O&&delete d.images});const ie=r.filter(d=>(d==null?void 0:d.files)??null).map(d=>d.files.filter(N=>N.type==="doc"||N.type==="collection")).flat(1),[F,ce]=await _t(localStorage.token,{model:e,messages:b,options:{...s.options??{}},format:s.requestFormat??void 0,keep_alive:s.keepAlive??void 0,docs:ie.length>0?ie:void 0});if(F&&F.ok){console.log("controller",ce);const d=F.body.pipeThrough(new TextDecoderStream).pipeThrough(qe(`
`)).getReader();for(;;){const{value:N,done:ae}=await d.read();if(ae||T||y!==p){a.done=!0,t(12,r),t(1,l),T&&(ce.abort("User: Stop Response"),await Fe(localStorage.token,U)),t(5,U=null);break}try{let D=N.split(`
`);for(const i of D)if(i!==""){let m=JSON.parse(i);if("detail"in m)throw m;if("id"in m)t(5,U=m.id);else if(m.done==!1){if(a.content==""&&m.message.content==`
`)continue;a.content+=m.message.content,t(12,r),t(1,l)}else{if(a.done=!0,a.content==""&&(a.error=!0,a.content="Oops! No text generated from Ollama, Please try again."),a.context=m.context??null,a.info={total_duration:m.total_duration,load_duration:m.load_duration,sample_count:m.sample_count,sample_duration:m.sample_duration,prompt_eval_count:m.prompt_eval_count,prompt_eval_duration:m.prompt_eval_duration,eval_count:m.eval_count,eval_duration:m.eval_duration},t(12,r),t(1,l),s.notificationEnabled&&!document.hasFocus()){const G=new Notification(P?`${P.title.charAt(0).toUpperCase()+P.title.slice(1)}`:`${e}`,{body:a.content,icon:(P==null?void 0:P.imageUrl)??`${Je}/static/favicon.png`})}s.responseAutoCopy&&Ve(a.content),s.responseAutoPlayback&&(await H(),(ue=document.getElementById(`speak-button-${a.id}`))==null||ue.click())}}}catch(D){console.log(D),"detail"in D&&B.error(D.detail);break}W()}p==y&&(s.saveChatHistory??!0)&&(M=await he(localStorage.token,y,{messages:r,history:l}),await ge.set(await me(localStorage.token)))}else{if(F!==null){const d=await F.json();console.log(d),"detail"in d?(B.error(d.detail),a.content=d.detail):(B.error(d.error),a.content=d.error)}else B.error("Uh-oh! There was an issue connecting to Ollama."),a.content="Uh-oh! There was an issue connecting to Ollama.";a.error=!0,a.content="Uh-oh! There was an issue connecting to Ollama.",a.done=!0,t(12,r),t(1,l)}T=!1,await H(),W(),r.length==2&&r.at(1).content!==""&&(window.history.replaceState(l.state,"",`/c/${y}`),await ye(y,c))},we=async(e,c,h,y)=>{var ie,F,ce,ue,d,N,ae,D;const a=l.messages[h];console.log("debug",a),W();const b=r.filter(i=>(i==null?void 0:i.files)??null).map(i=>i.files.filter(m=>m.type==="doc"||m.type==="collection")).flat(1);console.log(b);const O=await Mt(localStorage.token,{model:e.id,stream:!0,messages:[s.system?{role:"system",content:s.system}:void 0,...r].filter(i=>i).map((i,m,G)=>{var ke;return{role:i.role,...((ke=i.files)==null?void 0:ke.filter(q=>q.type==="image").length)>0?{content:[{type:"text",text:G.length-1!==m?i.content:(i==null?void 0:i.raContent)??i.content},...i.files.filter(q=>q.type==="image").map(q=>({type:"image_url",image_url:{url:q.url}}))]}:{content:G.length-1!==m?i.content:(i==null?void 0:i.raContent)??i.content}}}),seed:((ie=s==null?void 0:s.options)==null?void 0:ie.seed)??void 0,stop:((F=s==null?void 0:s.options)==null?void 0:F.stop)??void 0,temperature:((ce=s==null?void 0:s.options)==null?void 0:ce.temperature)??void 0,top_p:((ue=s==null?void 0:s.options)==null?void 0:ue.top_p)??void 0,num_ctx:((d=s==null?void 0:s.options)==null?void 0:d.num_ctx)??void 0,frequency_penalty:((N=s==null?void 0:s.options)==null?void 0:N.repeat_penalty)??void 0,max_tokens:((ae=s==null?void 0:s.options)==null?void 0:ae.num_predict)??void 0,docs:b.length>0?b:void 0},e.source==="litellm"?`${ut}/v1`:`${ft}`);if(O&&O.ok){const i=O.body.pipeThrough(new TextDecoderStream).pipeThrough(qe(`
`)).getReader();let m=!1;for(;;){const{value:G,done:ke}=await i.read();if(ke||T||y!==p){a.done=!0,t(12,r),t(1,l);break}try{let q=G.split(`
`);for(const Re of q)if(Re!=="")if(Re==="data: [DONE]")a.done=!0,t(12,r),t(1,l);else{let Ie=JSON.parse(Re.replace(/^data: /,""));if(Ie.type==="image")a.files=[{type:"image",url:`data:image/png;base64,${Ie.data}`}],m=!0,t(12,r),t(1,l);else{if(a.content==""&&Ie.choices[0].delta.content==`
`)continue;a.content+=Ie.choices[0].delta.content??"",t(12,r),t(1,l)}console.log("debug",a)}}catch(q){console.log(q)}s.notificationEnabled&&!document.hasFocus()&&new Notification(`OpenAI ${e}`,{body:a.content,icon:`${Je}/static/favicon.png`}),s.responseAutoCopy&&Ve(a.content),s.responseAutoPlayback&&(await H(),(D=document.getElementById(`speak-button-${a.id}`))==null||D.click()),W()}p==y&&(s.saveChatHistory??!0)&&(M=await he(localStorage.token,y,{messages:r,history:l}),await ge.set(await me(localStorage.token)))}else{if(O!==null){const i=await O.json();console.log(i),"detail"in i?(B.error(i.detail),a.content=i.detail):"message"in i.error?(B.error(i.error.message),a.content=i.error.message):(B.error(i.error),a.content=i.error)}else B.error(`Uh-oh! There was an issue connecting to ${e}.`),a.content=`Uh-oh! There was an issue connecting to ${e}.`;a.error=!0,a.content=`Uh-oh! There was an issue connecting to ${e}.`,a.done=!0,t(12,r),t(1,l)}T=!1,await H(),W(),r.length==2&&(window.history.replaceState(l.state,"",`/c/${y}`),await n(y,c))},Be=()=>{T=!0,console.log("stopResponse")},Ue=async()=>{console.log("continueGeneration");const e=JSON.parse(JSON.stringify(p));if(r.length!=0&&r.at(-1).done==!0){const c=l.messages[l.currentId];c.done=!1,await H();const h=u.filter(y=>y.id===c.model).at(0);h&&(h!=null&&h.external?await we(h,l.messages[c.parentId].content,c.id,e):await Q(h,l.messages[c.parentId].content,c.id,e))}else B.error(`Model ${modelId} not found`)},ne=async()=>{if(console.log("regenerateResponse"),r.length!=0&&r.at(-1).done==!0){r.splice(r.length-1,1),t(12,r),t(1,l);let e=r.at(-1),c=e.content;await re(c,e.id)}},ye=async(e,c)=>{if(s.titleAutoGenerate??!0){const h=await wt(localStorage.token,(s==null?void 0:s.titleGenerationPrompt)??"Create a concise, 3-5 word phrase as a header for the following query, strictly adhering to the 3-5 word limit and avoiding the use of the word 'title': {{prompt}}",(s==null?void 0:s.titleAutoGenerateModel)??k[0],c);h&&await n(e,h)}else await n(e,`${c}`)},n=async(e,c)=>{e===p&&t(9,K=c),M=await he(localStorage.token,e,{title:c}),await ge.set(await me(localStorage.token))},g=async()=>await kt(localStorage.token,p).catch(async e=>[]),A=async e=>{await bt(localStorage.token,p,e),t(8,L=await g()),M=await he(localStorage.token,p,{tags:L}),Ge.set(await ze(localStorage.token))},j=async e=>{await St(localStorage.token,p,e),t(8,L=await g()),M=await he(localStorage.token,p,{tags:L}),Ge.set(await ze(localStorage.token))};ot(async()=>{(s.saveChatHistory??!0)||await Ne("/")});const E=async()=>{U!==null&&(await Fe(localStorage.token,U),t(5,U=null)),Ne("/")};function R(e){k=e,t(0,k)}function be(e){l=e,t(1,l)}function Se(e){r=e,t(12,r),t(1,l)}function Ke(e){w=e,t(3,w)}function Qe(e){z[e?"unshift":"push"](()=>{C=e,t(4,C)})}const Xe=e=>{t(3,w=C.scrollHeight-C.scrollTop<=C.clientHeight+50)};function Ze(e){v=e,t(11,v)}function xe(e){J=e,t(10,J)}function $e(e){w=e,t(3,w)}return o.$$.update=()=>{if(o.$$.dirty[0]&33554433&&t(6,P=k.length===1&&_.filter(e=>e.tagName===k[0]).length>0?_.filter(e=>e.tagName===k[0])[0]:null),o.$$.dirty[0]&33554433&&t(7,I=k.reduce((e,c,h,y)=>{var b;const a=((b=_.filter(O=>O.tagName===c))==null?void 0:b.at(0))??void 0;return{...e,...a&&{[c]:a}}},{})),o.$$.dirty[0]&2)if(l.currentId!==null){let e=[],c=l.messages[l.currentId];for(;c!==null;)e.unshift({...c}),c=c.parentId!==null?l.messages[c.parentId]:null;t(12,r=e)}else t(12,r=[]);o.$$.dirty[0]&16777216&&f.params.id&&(async()=>{if(await _e()){await H(),t(2,se=!0),window.setTimeout(()=>W(),0);const e=document.getElementById("chat-textarea");e==null||e.focus()}else await Ne("/")})()},[k,l,se,w,C,U,P,I,L,K,J,v,r,s,p,oe,Y,Oe,re,Be,Ue,ne,A,j,f,_,E,R,be,Se,Ke,Qe,Xe,Ze,xe,$e]}class Vt extends nt{constructor(S){super(),at(this,S,At,Pt,et,{},null,[-1,-1])}}export{Vt as component};
