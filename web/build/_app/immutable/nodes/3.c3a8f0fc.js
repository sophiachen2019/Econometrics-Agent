import{s as Ke,p as Y,a as Me,f as fe,M as Qe,d as F,c as Ie,g as pe,h as de,j as X,i as He,r as Z,u as Xe,W as x,w as $,o as Ze,t as z}from"../chunks/scheduler.161605a7.js";import{S as xe,i as $e,f as ee,b as Te,d as Ce,m as Ee,a as Pe,t as Ae,e as Ne}from"../chunks/index.acd0f037.js";import{g as et}from"../chunks/globals.7f7f1b26.js";import{a as O}from"../chunks/Toaster.svelte_svelte_type_style_lang.51e71bae.js";import"../chunks/paths.ac3d22b5.js";import{p as tt}from"../chunks/stores.3e8eb66e.js";import{g as Oe,s as Le,e as ge,a as Ge,L as ot,O as st,f as Je,m as nt,c as at,j as lt,W as rt}from"../chunks/index.7deef04d.js";import{v as We,s as je,c as qe}from"../chunks/index.496e36ff.js";import{e as it,f as ct,h as Ve}from"../chunks/index.781620a4.js";import{c as ut,b as me,t as he,y as ft,x as Fe,z as pt,A as dt}from"../chunks/index.9f4636fe.js";import{d as gt}from"../chunks/index.1d44562a.js";import{N as mt,M as ht,a as _t,b as wt}from"../chunks/Navbar.6cdab601.js";const{document:De}=et;function yt(n){var be;let K,o,t,g,G,w,S,M,E,D,y,I,T,u,P,te,v,J,b,q,A,r,a,oe,W;De.title=K=`
		`+(n[7]?`${n[7].length>30?`${n[7].slice(0,30)}...`:n[7]} | ${n[14]}`:`${n[14]}`)+`
	`,g=new mt({props:{title:n[7],shareEnabled:n[10].length>0,initNewChat:n[15],tags:n[6],addTag:n[21],deleteTag:n[22]}});function ve(s){n[24](s)}let se={};n[0]!==void 0&&(se.selectedModels=n[0]),E=new ht({props:se}),Y.push(()=>ee(E,"selectedModels",ve));function _e(s){n[25](s)}function we(s){n[26](s)}function Be(s){n[27](s)}let ne={chatId:n[12],selectedModels:n[0],selectedModelfiles:n[5],processing:St,bottomPadding:n[9].length>0,sendPrompt:n[17],continueGeneration:n[20],regenerateResponse:n[19]};n[1]!==void 0&&(ne.history=n[1]),n[10]!==void 0&&(ne.messages=n[10]),n[2]!==void 0&&(ne.autoScroll=n[2]),u=new _t({props:ne}),Y.push(()=>ee(u,"history",_e)),Y.push(()=>ee(u,"messages",we)),Y.push(()=>ee(u,"autoScroll",Be));function Ue(s){n[30](s)}function ye(s){n[31](s)}function Se(s){n[32](s)}let ae={suggestionPrompts:((be=n[4])==null?void 0:be.suggestionPrompts)??n[13].default_prompt_suggestions,messages:n[10],submitPrompt:n[16],stopResponse:n[18]};return n[9]!==void 0&&(ae.files=n[9]),n[8]!==void 0&&(ae.prompt=n[8]),n[2]!==void 0&&(ae.autoScroll=n[2]),b=new wt({props:ae}),Y.push(()=>ee(b,"files",Ue)),Y.push(()=>ee(b,"prompt",ye)),Y.push(()=>ee(b,"autoScroll",Se)),{c(){o=Me(),t=fe("div"),Te(g.$$.fragment),G=Me(),w=fe("div"),S=fe("div"),M=fe("div"),Te(E.$$.fragment),I=Me(),T=fe("div"),Te(u.$$.fragment),J=Me(),Te(b.$$.fragment),this.h()},l(s){Qe("svelte-1123lr8",De.head).forEach(F),o=Ie(s),t=pe(s,"DIV",{class:!0});var B=de(t);Ce(g.$$.fragment,B),G=Ie(B),w=pe(B,"DIV",{class:!0});var j=de(w);S=pe(j,"DIV",{class:!0,id:!0});var k=de(S);M=pe(k,"DIV",{class:!0});var U=de(M);Ce(E.$$.fragment,U),U.forEach(F),I=Ie(k),T=pe(k,"DIV",{class:!0});var Q=de(T);Ce(u.$$.fragment,Q),Q.forEach(F),k.forEach(F),J=Ie(j),Ce(b.$$.fragment,j),j.forEach(F),B.forEach(F),this.h()},h(){var s;X(M,"class",y=(((s=n[11])==null?void 0:s.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"),X(T,"class","h-full w-full flex flex-col py-8"),X(S,"class","pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0"),X(S,"id","messages-container"),X(w,"class","flex flex-col flex-auto"),X(t,"class","h-screen max-h-[100dvh] w-full flex flex-col")},m(s,h){He(s,o,h),He(s,t,h),Ee(g,t,null),Z(t,G),Z(t,w),Z(w,S),Z(S,M),Ee(E,M,null),Z(S,I),Z(S,T),Ee(u,T,null),n[28](S),Z(w,J),Ee(b,w,null),a=!0,oe||(W=Xe(S,"scroll",n[29]),oe=!0)},p(s,h){var Q,ke;(!a||h[0]&16512)&&K!==(K=`
		`+(s[7]?`${s[7].length>30?`${s[7].slice(0,30)}...`:s[7]} | ${s[14]}`:`${s[14]}`)+`
	`)&&(De.title=K);const B={};h[0]&128&&(B.title=s[7]),h[0]&1024&&(B.shareEnabled=s[10].length>0),h[0]&64&&(B.tags=s[6]),g.$set(B);const j={};!D&&h[0]&1&&(D=!0,j.selectedModels=s[0],x(()=>D=!1)),E.$set(j),(!a||h[0]&2048&&y!==(y=(((Q=s[11])==null?void 0:Q.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"))&&X(M,"class",y);const k={};h[0]&4096&&(k.chatId=s[12]),h[0]&1&&(k.selectedModels=s[0]),h[0]&32&&(k.selectedModelfiles=s[5]),h[0]&512&&(k.bottomPadding=s[9].length>0),!P&&h[0]&2&&(P=!0,k.history=s[1],x(()=>P=!1)),!te&&h[0]&1024&&(te=!0,k.messages=s[10],x(()=>te=!1)),!v&&h[0]&4&&(v=!0,k.autoScroll=s[2],x(()=>v=!1)),u.$set(k);const U={};h[0]&8208&&(U.suggestionPrompts=((ke=s[4])==null?void 0:ke.suggestionPrompts)??s[13].default_prompt_suggestions),h[0]&1024&&(U.messages=s[10]),!q&&h[0]&512&&(q=!0,U.files=s[9],x(()=>q=!1)),!A&&h[0]&256&&(A=!0,U.prompt=s[8],x(()=>A=!1)),!r&&h[0]&4&&(r=!0,U.autoScroll=s[2],x(()=>r=!1)),b.$set(U)},i(s){a||(Pe(g.$$.fragment,s),Pe(E.$$.fragment,s),Pe(u.$$.fragment,s),Pe(b.$$.fragment,s),a=!0)},o(s){Ae(g.$$.fragment,s),Ae(E.$$.fragment,s),Ae(u.$$.fragment,s),Ae(b.$$.fragment,s),a=!1},d(s){s&&(F(o),F(t)),Ne(g),Ne(E),Ne(u),n[28](null),Ne(b),oe=!1,W()}}}let St="";function bt(n,K,o){let t,g,G,w,S,M,E;$(n,Le,e=>o(11,t=e)),$(n,Oe,e=>o(12,g=e)),$(n,nt,e=>o(36,G=e)),$(n,at,e=>o(13,w=e)),$(n,tt,e=>o(37,S=e)),$(n,lt,e=>o(23,M=e)),$(n,rt,e=>o(14,E=e));let D=!1,y=!0,I,T=null,u=[""],P=null,te={},v=null,J=[],b="",q="",A=[],r=[],a={messages:{},currentId:null};Ze(async()=>{await oe()});const oe=async()=>{var f;T!==null&&(await Ve(localStorage.token,T),T=null),window.history.replaceState(a.state,"","/"),await Oe.set(""),o(2,y=!0),o(7,b=""),o(10,r=[]),o(1,a={messages:{},currentId:null}),S.url.searchParams.get("models")?o(0,u=(f=S.url.searchParams.get("models"))==null?void 0:f.split(",")):t!=null&&t.models?o(0,u=t==null?void 0:t.models):w!=null&&w.default_models?o(0,u=w==null?void 0:w.default_models.split(",")):o(0,u=[""]),o(0,u=u.map(m=>G.map(l=>l.id).includes(m)?m:""));let e=JSON.parse(localStorage.getItem("settings")??"{}");Le.set({...e});const c=document.getElementById("chat-textarea");setTimeout(()=>c==null?void 0:c.focus(),0)},W=()=>{o(3,I.scrollTop=I.scrollHeight,I)},ve=async(e,c=null)=>{if(console.log("submitPrompt",g),o(0,u=u.map(f=>G.map(m=>m.id).includes(f)?f:"")),u.includes(""))O.error("Model not selected");else if(r.length!=0&&r.at(-1).done!=!0)console.log("wait");else if(A.length>0&&A.filter(f=>f.upload_status===!1).length>0)O.error("Oops! Hold tight! Your files are still in the processing oven. We're cooking them up to perfection. Please be patient and we'll let you know once they're ready.");else{document.getElementById("chat-textarea").style.height="";let f=We(),m={id:f,parentId:r.length!==0?r.at(-1).id:null,childrenIds:[],role:"user",user:c??void 0,content:e,files:A.length>0?A:void 0,timestamp:Math.floor(Date.now()/1e3)};o(1,a.messages[f]=m,a),o(1,a.currentId=f,a),r.length!==0&&a.messages[r.at(-1).id].childrenIds.push(f),await z(),r.length==1&&(t.saveChatHistory??!0?(v=await ut(localStorage.token,{id:g,title:"New Chat",models:u,system:t.system??void 0,options:{...t.options??{}},messages:r,history:a,tags:[],timestamp:Date.now()}),await ge.set(await me(localStorage.token)),await Oe.set(v.id)):await Oe.set("local"),await z()),o(8,q=""),o(9,A=[]),await se(e,f)}},se=async(e,c)=>{const f=JSON.parse(JSON.stringify(g));await Promise.all(u.map(async m=>{const l=G.filter(_=>_.id===m).at(0);if(l){let _=We(),N={parentId:c,id:_,childrenIds:[],role:"assistant",content:"",model:l.id,timestamp:Math.floor(Date.now()/1e3)};o(1,a.messages[_]=N,a),o(1,a.currentId=_,a),c!==null&&o(1,a.messages[c].childrenIds=[...a.messages[c].childrenIds,_],a),l!=null&&l.external?await we(l,e,_,f):l&&await _e(l,e,_,f)}else O.error(`Model ${m} not found`)})),await ge.set(await me(localStorage.token))},_e=async(e,c,f,m)=>{var ue;e=e.id;const l=a.messages[f];await z(),W();const _=[t.system?{role:"system",content:t.system}:void 0,...r].filter(p=>p).map((p,C,le)=>{var d;const R={role:p.role,content:le.length-2!==C?p.content:(p==null?void 0:p.raContent)??p.content},i=(d=p.files)==null?void 0:d.filter(H=>H.type==="image").map(H=>H.url.slice(H.url.indexOf(",")+1));return i&&i.length>0&&(R.images=i),R});let N=-1;_.forEach((p,C)=>{p.images&&(N=C)}),_.forEach((p,C)=>{C!==N&&delete p.images});const ie=r.filter(p=>(p==null?void 0:p.files)??null).map(p=>p.files.filter(C=>C.type==="doc"||C.type==="collection")).flat(1),[V,ce]=await it(localStorage.token,{model:e,messages:_,options:{...t.options??{}},format:t.requestFormat??void 0,keep_alive:t.keepAlive??void 0,docs:ie.length>0?ie:void 0});if(V&&V.ok){console.log("controller",ce);const p=V.body.pipeThrough(new TextDecoderStream).pipeThrough(je(`
`)).getReader();for(;;){const{value:C,done:le}=await p.read();if(le||D||m!==g){l.done=!0,o(10,r),o(1,a),D&&(ce.abort("User: Stop Response"),await Ve(localStorage.token,T)),T=null;break}try{let R=C.split(`
`);for(const i of R)if(i!==""){console.log(i);let d=JSON.parse(i);if("detail"in d)throw d;if("id"in d)console.log(d),T=d.id;else if(d.done==!1){if(l.content==""&&d.message.content==`
`)continue;l.content+=d.message.content,o(10,r),o(1,a)}else{if(l.done=!0,l.content==""&&(l.error=!0,l.content="Oops! No text generated from Ollama, Please try again."),l.context=d.context??null,l.info={total_duration:d.total_duration,load_duration:d.load_duration,sample_count:d.sample_count,sample_duration:d.sample_duration,prompt_eval_count:d.prompt_eval_count,prompt_eval_duration:d.prompt_eval_duration,eval_count:d.eval_count,eval_duration:d.eval_duration},o(10,r),o(1,a),t.notificationEnabled&&!document.hasFocus()){const H=new Notification(P?`${P.title.charAt(0).toUpperCase()+P.title.slice(1)}`:`${e}`,{body:l.content,icon:(P==null?void 0:P.imageUrl)??`${Ge}/static/favicon.png`})}t.responseAutoCopy&&qe(l.content),t.responseAutoPlayback&&(await z(),(ue=document.getElementById(`speak-button-${l.id}`))==null||ue.click())}}}catch(R){console.log(R),"detail"in R&&O.error(R.detail);break}y&&W()}g==m&&(t.saveChatHistory??!0)&&(v=await he(localStorage.token,m,{messages:r,history:a}),await ge.set(await me(localStorage.token)))}else{if(V!==null){const p=await V.json();console.log(p),"detail"in p?(O.error(p.detail),l.content=p.detail):(O.error(p.error),l.content=p.error)}else O.error("Uh-oh! There was an issue connecting to Ollama."),l.content="Uh-oh! There was an issue connecting to Ollama.";l.error=!0,l.content="Uh-oh! There was an issue connecting to Ollama.",l.done=!0,o(10,r),o(1,a)}D=!1,await z(),y&&W(),r.length==2&&r.at(1).content!==""&&(window.history.replaceState(a.state,"",`/c/${m}`),await ye(m,c))},we=async(e,c,f,m)=>{var ie,V,ce,ue,p,C,le,R;const l=a.messages[f];W();const _=r.filter(i=>(i==null?void 0:i.files)??null).map(i=>i.files.filter(d=>d.type==="doc"||d.type==="collection")).flat(1);console.log(_);const N=await gt(localStorage.token,{model:e.id,stream:!0,messages:[t.system?{role:"system",content:t.system}:void 0,...r].filter(i=>i).map((i,d,H)=>{var re;return{role:i.role,...((re=i.files)==null?void 0:re.filter(L=>L.type==="image").length)>0?{content:[{type:"text",text:H.length-1!==d?i.content:(i==null?void 0:i.raContent)??i.content},...i.files.filter(L=>L.type==="image").map(L=>({type:"image_url",image_url:{url:L.url}}))]}:{content:H.length-1!==d?i.content:(i==null?void 0:i.raContent)??i.content}}}),seed:((ie=t==null?void 0:t.options)==null?void 0:ie.seed)??void 0,stop:((V=t==null?void 0:t.options)==null?void 0:V.stop)??void 0,temperature:((ce=t==null?void 0:t.options)==null?void 0:ce.temperature)??void 0,top_p:((ue=t==null?void 0:t.options)==null?void 0:ue.top_p)??void 0,num_ctx:((p=t==null?void 0:t.options)==null?void 0:p.num_ctx)??void 0,frequency_penalty:((C=t==null?void 0:t.options)==null?void 0:C.repeat_penalty)??void 0,max_tokens:((le=t==null?void 0:t.options)==null?void 0:le.num_predict)??void 0,docs:_.length>0?_:void 0},e.source==="litellm"?`${ot}/v1`:`${st}`);if(N&&N.ok){const i=N.body.pipeThrough(new TextDecoderStream).pipeThrough(je(`
`)).getReader();for(;;){const{value:d,done:H}=await i.read();if(H||D||m!==g){l.done=!0,o(10,r),o(1,a);break}try{let re=d.split(`
`);for(const L of re)if(L!=="")if(console.log(L),L==="data: [DONE]")l.done=!0,o(10,r),o(1,a);else{let Re=JSON.parse(L.replace(/^data: /,""));if(console.log(Re),l.content==""&&Re.choices[0].delta.content==`
`)continue;l.content+=Re.choices[0].delta.content??"",o(10,r),o(1,a)}}catch(re){console.log(re)}t.notificationEnabled&&!document.hasFocus()&&new Notification(`OpenAI ${e}`,{body:l.content,icon:`${Ge}/static/favicon.png`}),t.responseAutoCopy&&qe(l.content),t.responseAutoPlayback&&(await z(),(R=document.getElementById(`speak-button-${l.id}`))==null||R.click()),y&&W()}g==m&&(t.saveChatHistory??!0)&&(v=await he(localStorage.token,m,{messages:r,history:a}),await ge.set(await me(localStorage.token)))}else{if(N!==null){const i=await N.json();console.log(i),"detail"in i?(O.error(i.detail),l.content=i.detail):"message"in i.error?(O.error(i.error.message),l.content=i.error.message):(O.error(i.error),l.content=i.error)}else O.error(`Uh-oh! There was an issue connecting to ${e}.`),l.content=`Uh-oh! There was an issue connecting to ${e}.`;l.error=!0,l.content=`Uh-oh! There was an issue connecting to ${e}.`,l.done=!0,o(10,r),o(1,a)}D=!1,await z(),y&&W(),r.length==2&&(window.history.replaceState(a.state,"",`/c/${m}`),t!=null&&t.titleAutoGenerateModel?await ye(m,c):await s(m,c))},Be=()=>{D=!0,console.log("stopResponse")},ne=async()=>{if(console.log("regenerateResponse"),r.length!=0&&r.at(-1).done==!0){r.splice(r.length-1,1),o(10,r),o(1,a);let e=r.at(-1),c=e.content;await se(c,e.id)}},Ue=async()=>{console.log("continueGeneration");const e=JSON.parse(JSON.stringify(g));if(r.length!=0&&r.at(-1).done==!0){const c=a.messages[a.currentId];c.done=!1,await z();const f=G.filter(m=>m.id===c.model).at(0);f&&(f!=null&&f.external?await we(f,a.messages[c.parentId].content,c.id,e):await _e(f,a.messages[c.parentId].content,c.id,e))}else O.error(`Model ${modelId} not found`)},ye=async(e,c)=>{if(t.titleAutoGenerate??!0){const f=await ct(localStorage.token,(t==null?void 0:t.titleGenerationPrompt)??"Create a concise, 3-5 word phrase as a header for the following query, strictly adhering to the 3-5 word limit and avoiding the use of the word 'title': {{prompt}}",(t==null?void 0:t.titleAutoGenerateModel)??u[0],c);f&&await s(e,f)}else await s(e,`${c}`)},Se=async()=>await dt(localStorage.token,g).catch(async e=>[]),ae=async e=>{await ft(localStorage.token,g,e),o(6,J=await Se()),v=await he(localStorage.token,g,{tags:J}),Je.set(await Fe(localStorage.token))},be=async e=>{await pt(localStorage.token,g,e),o(6,J=await Se()),v=await he(localStorage.token,g,{tags:J}),Je.set(await Fe(localStorage.token))},s=async(e,c)=>{e===g&&o(7,b=c),(t.saveChatHistory??!0)&&(v=await he(localStorage.token,e,{title:c}),await ge.set(await me(localStorage.token)))};function h(e){u=e,o(0,u)}function B(e){a=e,o(1,a)}function j(e){r=e,o(10,r),o(1,a)}function k(e){y=e,o(2,y)}function U(e){Y[e?"unshift":"push"](()=>{I=e,o(3,I)})}const Q=e=>{o(2,y=I.scrollHeight-I.scrollTop<=I.clientHeight+50)};function ke(e){A=e,o(9,A)}function ze(e){q=e,o(8,q)}function Ye(e){y=e,o(2,y)}return n.$$.update=()=>{if(n.$$.dirty[0]&8388609&&o(4,P=u.length===1&&M.filter(e=>e.tagName===u[0]).length>0?M.filter(e=>e.tagName===u[0])[0]:null),n.$$.dirty[0]&8388609&&o(5,te=u.reduce((e,c,f,m)=>{var _;const l=((_=M.filter(N=>N.tagName===c))==null?void 0:_.at(0))??void 0;return{...e,...l&&{[c]:l}}},{})),n.$$.dirty[0]&2)if(a.currentId!==null){let e=[],c=a.messages[a.currentId];for(;c!==null;)e.unshift({...c}),c=c.parentId!==null?a.messages[c.parentId]:null;o(10,r=e)}else o(10,r=[])},[u,a,y,I,P,te,J,b,q,A,r,t,g,w,E,oe,ve,se,Be,ne,Ue,ae,be,M,h,B,j,k,U,Q,ke,ze,Ye]}class Ut extends xe{constructor(K){super(),$e(this,K,bt,yt,Ke,{},null,[-1,-1])}}export{Ut as component};
